!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios")):"function"==typeof define&&define.amd?define(["axios"],t):(e=e||self).TQSDK=t(e.axios)}(this,(function(axios){"use strict";axios=axios&&axios.hasOwnProperty("default")?axios.default:axios;var version="1.1.1",db_version="3";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _get(e,t,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=_superPropBase(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var eventemitter3=createCommonjsModule((function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function o(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,r,i,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var s=new o(r,i||e,a),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function s(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),s.prototype.eventNames=function(){var e,r,o=[];if(0===this._eventsCount)return o;for(r in e=this._events)t.call(e,r)&&o.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},s.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var o=0,i=r.length,a=new Array(i);o<i;o++)a[o]=r[o].fn;return a},s.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},s.prototype.emit=function(e,t,r,o,i,a){var s=n?n+e:e;if(!this._events[s])return!1;var c,u,f=this._events[s],l=arguments.length;if(f.fn){switch(f.once&&this.removeListener(e,f.fn,void 0,!0),l){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,t),!0;case 3:return f.fn.call(f.context,t,r),!0;case 4:return f.fn.call(f.context,t,r,o),!0;case 5:return f.fn.call(f.context,t,r,o,i),!0;case 6:return f.fn.call(f.context,t,r,o,i,a),!0}for(u=1,c=new Array(l-1);u<l;u++)c[u-1]=arguments[u];f.fn.apply(f.context,c)}else{var d,h=f.length;for(u=0;u<h;u++)switch(f[u].once&&this.removeListener(e,f[u].fn,void 0,!0),l){case 1:f[u].fn.call(f[u].context);break;case 2:f[u].fn.call(f[u].context,t);break;case 3:f[u].fn.call(f[u].context,t,r);break;case 4:f[u].fn.call(f[u].context,t,r,o);break;default:if(!c)for(d=1,c=new Array(l-1);d<l;d++)c[d-1]=arguments[d];f[u].fn.apply(f[u].context,c)}}return!0},s.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,r,o){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var s=this._events[i];if(s.fn)s.fn!==t||o&&!s.once||r&&s.context!==r||a(this,i);else{for(var c=0,u=[],f=s.length;c<f;c++)(s[c].fn!==t||o&&!s[c].once||r&&s[c].context!==r)&&u.push(s[c]);u.length?this._events[i]=1===u.length?u[0]:u:a(this,i)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s})),IsEmptyObject=function(e){return e&&e.constructor===Object&&0===Object.keys(e).length},RandomStr=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),n="",r=0;r<e;r++)n+=t[62*Math.random()|0];return n};function _genList(e){for(var t=[],n=e.split("|"),r=0;r<n.length;r++)t.push(n[r].trim());return t}function _genItem(e,t){for(var n={},r=0;r<e.length;r++)n[e[r]]=t[r];return n}function _genTableRow(e,t,n,r){var o={state:e,state_detail:t,isRow:!1,row:null};switch(t){case"T":""===r.replace(/-/g,"")?o.state_detail="C":n[e]=_genList(r);break;case"C":""===r.replace(/-/g,"")?o.state_detail="S":(o.isRow=!0,o.row=_genItem(n[e],_genList(r)));break;case"S":""===r.replace(/-/g,"")&&(o.state="",o.state_detail="")}return o}var ParseSettlementContent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(""===e)return e;var t=e.split("\n"),n="",r="",o={},i={positionClosed:"平仓明细 Position Closed",transactionRecords:"成交记录 Transaction Record",positions:"持仓汇总 Positions",positionsDetail:"持仓明细 Positions Detail",delivery:"交割明细  Delivery"},a=[],s=[],c={account:{}};Object.entries(i).forEach((function(e){a.push(e[0]),s.push(e[1]),c[e[0]]=[]}));for(var u=0;u<t.length;u++){var f=t[u].trim();if("资金状况  币种：人民币  Account Summary  Currency：CNY"!==f){if(s.includes(f))n=a[s.indexOf(f)],r="T",u++;else if("A-S"===n){if(0===f.length||""===f.replace("-","")){n="";continue}f.match(/([\u4e00-\u9fa5][\u4e00-\u9fa5\s]+[\u4e00-\u9fa5])+/g);for(var l=f.match(/([A-Z][a-zA-Z\.\/\(\)\s]+)[:：]+/g),d=f.match(/(-?[\d]+\.\d\d)/g),h=0;h<l.length;h++)c.account[l[h].split(/[:：]/)[0]]=d[h]}else if(a.includes(n)){if(0===f.length){n="";continue}var _=_genTableRow(n,r,o,f);n=_.state,r=_.state_detail,_.isRow&&c[n].push(_.row)}}else n="A-S",u++}return c},TqWebsocket=function(_EventEmitter){function TqWebsocket(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return _classCallCheck(this,TqWebsocket),(t=_possibleConstructorReturn(this,_getPrototypeOf(TqWebsocket).call(this))).urlList=e instanceof Array?e:[e],t.ws=null,t.queue=[],t.reconnect=!0,t.reconnectTask=null,t.reconnectInterval=n.reconnectInterval?n.reconnectInterval:3e3,t.reconnectMaxTimes=n.reconnectMaxTimes?n.reconnectMaxTimes:5,t.reconnectTimes=0,t.reconnectUrlIndex=0,t.STATUS={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},t.__init(),t}return _inherits(TqWebsocket,_EventEmitter),_createClass(TqWebsocket,[{key:"send",value:function(e){var t=JSON.stringify(e);this.isReady()?this.ws.send(t):this.queue.push(t)}},{key:"isReady",value:function(){return this.ws.readyState===WebSocket.OPEN}},{key:"__init",value:function __init(){this.ws=new WebSocket(this.urlList[this.reconnectUrlIndex]),this.reconnectUrlIndex===this.urlList.length-1&&(this.reconnectTimes+=1);var _this=this;this.ws.onmessage=function(message){var data=eval("("+message.data+")");_this.emit("message",data),setImmediate((function(){_this.ws.send('{"aid":"peek_message"}')}))},this.ws.onclose=function(e){console.log("close",e),_this.emit("close"),_this.queue=[],_this.reconnect&&(_this.reconnectMaxTimes<=_this.reconnectTimes?(clearTimeout(_this.reconnectTask),_this.emit("death",{msg:"超过重连次数"+_this.reconnectMaxTimes})):_this.reconnectTask=setTimeout((function(){3===_this.ws.readyState&&(_this.reconnectUrlIndex=_this.reconnectUrlIndex+1<_this.urlList.length?_this.reconnectUrlIndex+1:0,_this.__init(),_this.emit("reconnect",{msg:"发起重连第 "+_this.reconnectTimes+" 次"}))}),_this.reconnectInterval))},this.ws.onerror=function(e){_this.emit("error",e),_this.ws.close()},this.ws.onopen=function(){for(_this.emit("open",{msg:"发起重连第 "+_this.reconnectTimes+" 次, 成功"}),_this.reconnectTimes=0,_this.reconnectUrlIndex=0,this.reconnectTask&&clearTimeout(_this.reconnectTask);_this.queue.length>0&&1===_this.ws.readyState;)_this.ws.send(_this.queue.shift())}}},{key:"close",value:function(){this.ws.onclose=function(){},this.ws.close()}}]),TqWebsocket}(eventemitter3),TqTradeWebsocket=function(e){function t(e,n){var r,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return _classCallCheck(this,t),(r=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,o))).dm=n,r.req_login=null,r.init(),r}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){var e=this;this.on("message",(function(t){if("rtn_data"===t.aid){for(var n=e._separateNotifies(t.data),r=0;r<n.length;r++)e.emit("notify",n[r]);e.dm.mergeData(t.data)}else if("rtn_brokers"===t.aid)e.emit("rtn_brokers",t.brokers);else if("qry_settlement_info"===t.aid){var o=ParseSettlementContent(t.settlement_info);e.dm.mergeData({trade:_defineProperty({},t.user_name,{his_settlements:_defineProperty({},t.trading_day,o)})}),TQSDK.store&&TQSDK.store.setContent(t.user_name,t.trading_day,t.settlement_info)}})),this.on("reconnect",(function(){e.req_login&&e.send(e.req_login)}))}},{key:"_separateNotifies",value:function(e){for(var t=[],n=0;n<e.length;n++)if(e[n].notify){var r=e.splice(n--,1)[0].notify;for(var o in r)t.push(r[o])}return t}},{key:"send",value:function(e){"req_login"===e.aid&&(this.req_login=e),_get(_getPrototypeOf(t.prototype),"send",this).call(this,e)}}]),t}(TqWebsocket),TqQuoteWebsocket=function(e){function t(e,n){var r,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return _classCallCheck(this,t),(r=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,o))).dm=n,r.subscribe_quote=null,r.charts={},r.init(),r}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){var e=this;this.on("message",(function(t){"rtn_data"===t.aid&&e.dm.mergeData(t.data)})),this.on("reconnect",(function(t){for(var n in console.log(t),e.subscribe_quote&&e.send(e.subscribe_quote),e.charts)e.charts[n].view_width>0&&e.send(e.charts[n])}))}},{key:"send",value:function(e){"subscribe_quote"===e.aid?null!==this.subscribe_quote&&JSON.stringify(e.ins_list)===JSON.stringify(this.subscribe_quote.ins_list)||(this.subscribe_quote=e,_get(_getPrototypeOf(t.prototype),"send",this).call(this,e)):"set_chart"===e.aid&&(0===e.view_width?this.charts[e.chart_id]&&delete this.charts[e.chart_id]:this.charts[e.chart_id]=e,_get(_getPrototypeOf(t.prototype),"send",this).call(this,e))}}]),t}(TqWebsocket),TqRecvOnlyWebsocket=function(e){function t(e,n){var r,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return _classCallCheck(this,t),(r=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,o))).dm=n,r.init(),r}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){var e=this;this.on("message",(function(t){"rtn_data"===t.aid&&e.dm.mergeData(t.data)})),this.on("reconnect",(function(e){console.log(e)}))}}]),t}(TqWebsocket),QUOTE=function(){function e(){_classCallCheck(this,e),this.instrument_id="",this.datetime="",this._last_price="-",this.ask_price1="-",this.ask_volume1="-",this.bid_price1="-",this.bid_volume1="-",this.highest="-",this.lowest="-",this.open="-",this.close="-",this.average="-",this.volume="-",this.amount="-",this.open_interest="-",this.lower_limit="-",this.upper_limit="-",this.settlement="-",this.change="-",this.change_percent="-",this.strike_price=NaN,this.pre_open_interest="-",this.pre_close="-",this.pre_volume="-",this._pre_settlement="-",this.margin="-",this.commission="-"}return _createClass(e,[{key:"setChange",value:function(){Number.isFinite(this._last_price)&&Number.isFinite(this._pre_settlement)&&0!==this._pre_settlement&&(this.change=this._last_price-this._pre_settlement,this.change_percent=this.change/this._pre_settlement*100)}},{key:"last_price",set:function(e){this._last_price=e,this.setChange()},get:function(){return this._last_price}},{key:"pre_settlement",set:function(e){this._pre_settlement=e,this.setChange()},get:function(){return this._pre_settlement}}]),e}(),DataManager=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._epoch=0,e._data=n,e._diffs=[],e}return _inherits(t,e),_createClass(t,[{key:"mergeData",value:function(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=Array.isArray(e)?e:[e];n&&(this._epoch+=1,this._diffs=o);var i=!0,a=!1,s=void 0;try{for(var c,u=o[Symbol.iterator]();!(i=(c=u.next()).done);i=!0){var f=c.value;null===f||IsEmptyObject(f)||t.MergeObject(this._data,f,this._epoch,r)}}catch(e){a=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw s}}n&&this._data._epoch===this._epoch&&this.emit("data",null)}},{key:"isChanging",value:function(e){if(Array.isArray(e)){for(var t=this._data,n=0;n<e.length;n++){if((t=t[e[n]])._epoch&&t._epoch===this._epoch)return!0;if(void 0===t)return!1}return!1}return!(!e||!e._epoch)&&e._epoch===this._epoch}},{key:"setDefault",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._data;return t.SetDefault(r,e,n)}},{key:"getByPath",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._data;return t.GetByPath(n,e)}}]),t}(eventemitter3);DataManager.SetDefault=function(e,t,n){for(var r=e,o=0;o<t.length;o++){if("string"!=typeof t[o]&&"number"!=typeof t[o]){console.error("SetDefault, pathArray 中的元素必須是 string or number, but pathArray = ",t);break}var i=t[o];if(i in r||(r[i]=o===t.length-1?n:{}),o===t.length-1)return r[i];r=r[i]}return r},DataManager.GetByPath=function(e,t){for(var n=e,r=0;r<t.length;r++)if(null==(n=n[t[r]]))return n;return n},DataManager.MergeObject=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];for(var o in t){var i=t[o],a=_typeof(i);if(["string","boolean","number"].includes(a))e[o]="NaN"===i?NaN:i;else if(null===i&&r)delete e[o];else if(Array.isArray(i))e[o]=i,i._epoch||Object.defineProperty(i,"_epoch",{configurable:!1,enumerable:!1,writable:!0}),i._epoch=n;else if("object"===a)if(e[o]=e[o]||("data"===o?[]:{}),"quotes"===o)for(var s in i){var c=i[s];null!==c?(e[o][s]||(e[o][s]=new QUOTE),DataManager.MergeObject(e[o][s],c,n,r)):r&&s&&delete e[o][s]}else DataManager.MergeObject(e[o],i,n,r)}e._epoch||Object.defineProperty(e,"_epoch",{configurable:!1,enumerable:!1,writable:!0}),e._epoch=n};var TQSDK=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.symbolsServerUrl,o=void 0===r?"https://openmd.shinnytech.com/t/md/symbols/latest.json":r,i=n.wsQuoteUrl,a=void 0===i?"wss://openmd.shinnytech.com/t/md/front/mobile":i,s=n.wsTradeUrl,c=void 0===s?"wss://openmd.shinnytech.com/trade/user0":s,u=n.clientSystemInfo,f=void 0===u?"":u,l=n.clientAppId,d=void 0===l?"":l,h=n.autoInit,_=void 0===h||h,v=n.data,p=void 0===v?{klines:{},quotes:{},charts:{},ticks:{}}:v;_classCallCheck(this,t),(e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))._insUrl=o,e._mdUrl=a,e._tdUrl=c,e.clientSystemInfo=f,e.clientAppIds=d,e._prefix="TQJS_";var y=_assertThisInitialized(e);return e.dm=new DataManager(p),e.dm.on("data",(function(){y.emit("rtn_data",null)})),e.brokers=null,e.trade_accounts={},e.isReady=!1,e.quotesWs=null,e.quotesInfo={},_&&e.init(),e}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){this.initMdWebsocket(),this.initTdWebsocket();var e=this;axios.get(this._insUrl,{headers:{Accept:"application/json; charset=utf-8"}}).then((function(t){e.quotesInfo=t.data,e.isReady=!0,e.emit("ready"),e.emit("rtn_data",null)})).catch((function(t){return e.emit("error",t),console.error("Error: "+t.message),t}))}},{key:"initMdWebsocket",value:function(){this.quotesWs=new TqQuoteWebsocket(this._mdUrl,this.dm)}},{key:"initTdWebsocket",value:function(){var e=this;axios.get("https://files.shinnytech.com/broker-list.json",{headers:{Accept:"application/json; charset=utf-8"}}).then((function(t){e.brokers=Object.keys(t.data),e.emit("rtn_brokers",e.brokers),console.log(e.brokers)})).catch((function(t){return e.emit("error",t),console.error("Error: "+t.message),t}))}},{key:"addWebSocket",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e?new TqRecvOnlyWebsocket(e,this.dm):null}},{key:"addAccount",value:function(e,t,n){if(e&&t&&n){if(!this.brokers[e])return void console.error("不支持该期货公司");if(!this.trade_accounts[t]){console.log(this.brokers[e].url);var r=new TqTradeWebsocket(this.brokers[e].url,this.dm),o=this;r.on("notify",(function(n){o.emit("notify",Object.assign(n,{bid:e,user_id:t}))})),this.trade_accounts[t]={bid:e,userId:t,password:n,ws:r}}return this.trade_accounts[t]}return null}},{key:"removeAccount",value:function(e,t){e&&t&&this.trade_accounts[t]&&(this.trade_accounts[t].ws.close(),delete this.trade_accounts[t],delete this.dm._data.trade[t])}},{key:"updateData",value:function(e){this.dm.mergeData(e,!0,!1)}},{key:"getByPath",value:function(e){return this.dm.getByPath(e)}},{key:"getQuotesByInput",value:function(e){if("string"!=typeof e&&!e.input)return[];var t={input:"string"==typeof e?e.toLowerCase():e.input.toLowerCase(),instrument_id:!e.instrument_id||e.instrument_id,pinyin:!e.pinyin||e.pinyin,include_expired:!!e.include_expired&&e.include_expired,FUTURE:!e.future||!!e.future,FUTURE_INDEX:!!e.future_index&&!!e.future_index,FUTURE_CONT:!!e.future_cont&&!!e.future_cont,OPTION:!!e.option&&!!e.option,COMBINE:!!e.combine&&!!e.combine},n=function(e,t,n){return!(!e[t.class]||!e.include_expired&&(e.include_expired||t.expired))&&("instrument_id"===n?t.product_id.toLowerCase()===e.input||e.input.length>2&&t.instrument_id.toLowerCase().indexOf(e.input)>-1:"pinyin"===n&&t.py.split(",").indexOf(e.input)>-1)},r=[];if(t.instrument_id)for(var o in this.quotesInfo)n(t,this.quotesInfo[o],"instrument_id")&&r.push(o);if(t.pinyin)for(var i in this.quotesInfo)n(t,this.quotesInfo[i],"pinyin")&&r.push(i);return r}},{key:"getQuote",value:function(e){if(""===e)return{};var t=this.dm.setDefault(["quotes",e],new QUOTE);if(!t.class&&this.quotesInfo[e]){var n=t.last_price?t.last_price:this.quotesInfo[e].last_price;Object.assign(t,this.quotesInfo[e],{last_price:n})}return t}},{key:"setChart",value:function(e){var t={};e.trading_day_start||e.trading_day_count?(t.trading_day_start=e.trading_day_start?e.trading_day_start:0,t.trading_day_count=e.trading_day_count?e.trading_day_count:864e11):(t.view_width=e.view_width?e.view_width:500,e.left_kline_id?t.left_kline_id=e.left_kline_id:e.focus_datetime&&(t.focus_datetime=e.focus_datetime,t.focus_position=e.focus_position?e.focus_position:0)),this.quotesWs.send(Object.assign({aid:"set_chart",chart_id:e.chart_id?e.chart_id:this._prefix+"kline_chart",ins_list:e.ins_list?e.ins_list.join(","):e.symbol,duration:e.duration},t))}},{key:"getUser",value:function(e){var t="string"==typeof e?e:e.user_id;return t?this.dm._data.trade[t]:null}},{key:"get",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.name,n=void 0===t?"users":t,r=e.user_id,o=void 0===r?"":r,i=e.currency,a=void 0===i?"CNY":i,s=e.symbol,c=void 0===s?"":s,u=e.order_id,f=void 0===u?"":u,l=e.trade_id,d=void 0===l?"":l,h=e.trading_day,_=void 0===h?"":h,v=e.chart_id,p=void 0===v?"":v,y=e.input,m=void 0===y?"":y,g=e.duration,b=void 0===g?0:g;if("users"===n)return Object.keys(this.trade_accounts);if(o){var w=this.get_user(o);if("user"===n)return w;if(["session","accounts","positions","orders","trades","his_settlements"].indexOf(n)>-1)return w&&w[n]?w[n]:null;if(w&&w[n+"s"]){var S="account"===n?a:"position"===n?c:"order"===n?f:"trade"===n?d:"his_settlement"===n?_:"";return w[n+"s"][S]}return null}return"quotes"===n?m?this.get_quotes_by_input(m):[]:"quote"===n?this.getQuote(c):"klines"===n?this.getKlines(c,b):"ticks"===n?this.getTicks(c):"charts"===n?this.dm.getByPath(["charts"]):"chart"===n?this.dm.getByPath(["charts",p]):void 0}},{key:"getKlines",value:function(e,t){if(""===e)return null;var n=this.dm.getByPath(["klines",e,t]);return n&&n.data&&-1!==n.last_id||(this.dm.mergeData({klines:_defineProperty({},e,_defineProperty({},t,{last_id:-1,data:{}}))},!1,!1),n=this.dm.getByPath(["klines",e,t])),n}},{key:"getTicks",value:function(e){if(""===e)return null;var t=this.dm.getByPath(["ticks",e]);return t&&t.data||this.dm.mergeData({ticks:_defineProperty({},e,{last_id:-1,data:{}})},!1,!1),this.dm.getByPath(["ticks",e])}},{key:"isLogined",value:function(e){var t=this.get({name:"session",user_id:e.user_id});return!(!t||!t.trading_day)}},{key:"isChanging",value:function(e,t){return e&&e._epoch?e._epoch===this.dm._epoch:"string"==typeof e&&this.dm.isChanging(e,t)}},{key:"insertOrder",value:function(e){if(!this.is_logined(e))return null;var t=this._prefix+RandomStr(8),n={user_id:e.user_id,orderId:t,exchange_id:e.exchange_id,instrument_id:e.ins_id,direction:e.direction,offset:e.offset,price_type:e.price_type?e.price_type:"LIMIT",limit_price:Number(e.limit_price),volume_condition:"ANY",time_condition:"ANY"===e.price_type?"IOC":"GFD"},r=Object.assign({aid:"insert_order",volume:e.volume},n);this.trade_accounts[e.user_id].ws.send(r);var o=Object.assign({volume_orign:e.volume,status:"ALIVE",volume_left:e.volume},n);return this.dm.mergeData({trade:_defineProperty({},e.user_id,{orders:_defineProperty({},t,o)})},!1,!1),this.get({name:"order",user_id:e.user_id,orderId:t})}},{key:"autoInsertOrder",value:function(e){if(!this.is_logined(e))return null;var t={user_id:e.user_id,price_type:e.price_type?e.price_type:"LIMIT",volume_condition:"ANY",time_condition:"ANY"===e.price_type?"IOC":"GFD",exchange_id:e.exchange_id,instrument_id:e.ins_id,direction:e.direction,limit_price:Number(e.limit_price)};if("SHFE"===e.exchange_id&&"CLOSE"===e.offset){var n=this.dm.getPosition(e.symbol,e.user_id),r=0;"BUY"===e.direction&&n.volume_short_today>0?r=Math.min(n.volume_short_today,e.volume):"SELL"===e.direction&&n.volume_long_today>0&&(r=Math.min(n.volume_long_today,e.volume)),r>0&&this.insert_order(Object.assign({offset:"CLOSETODAY",volume:r},t)),e.volume-r>0&&this.insert_order(Object.assign({offset:"CLOSE",volume:e.volume-r},t))}else this.insert_order(Object.assign({offset:e.offset,volume:e.volume},t))}},{key:"cancelOrder",value:function(e){this.trade_accounts[e.user_id].ws.send({aid:"cancel_order",user_id:e.user_id,order_id:e.order_id?e.order_id:e})}},{key:"login",value:function(e){this.trade_accounts[e.user_id].ws.send({aid:"req_login",bid:e.bid,user_name:e.user_id,password:e.password,client_system_info:this.clientSystemInfo,client_app_id:this.clientAppId})}},{key:"confirmSettlement",value:function(e){this.trade_accounts[e.user_id].ws.send({aid:"confirm_settlement"})}},{key:"transfer",value:function(e){this.trade_accounts[e.user_id].ws.send({aid:"req_transfer",bank_id:e.bank_id,bank_password:e.bank_password,future_account:e.future_account,future_password:e.future_password,currency:"CNY",amount:e.amount})}},{key:"hisSettlement",value:function(e){if(!t.store)return null;var n=this.dm.getByPath(["trade",e.user_id,"his_settlements",e.trading_day]);if(void 0===n){var r=this;n=t.store.getContent(e.user_id,e.trading_day).then((function(t){if(null===t)r.trade_accounts[e.user_id].ws.send({aid:"qry_settlement_info",trading_day:Number(e.trading_day)});else{var n=ParseSettlementContent(t);r.dm.mergeData({trade:_defineProperty({},e.user_id,{his_settlements:_defineProperty({},e.trading_day,n)})},!0,!1)}})).catch((function(e){console.error(e)}))}}},{key:"subscribeQuote",value:function(e){this.quotesWs.send({aid:"subscribe_quote",ins_list:Array.isArray(e)?e.join(","):e})}}]),t}(eventemitter3);TQSDK.prototype.subscribe_quote=TQSDK.prototype.subscribeQuote,TQSDK.prototype.his_settlement=TQSDK.prototype.hisSettlement,TQSDK.prototype.confirm_settlement=TQSDK.prototype.confirmSettlement,TQSDK.prototype.add_account=TQSDK.prototype.addAccount,TQSDK.prototype.remove_account=TQSDK.prototype.removeAccount,TQSDK.prototype.update_data=TQSDK.prototype.updateData,TQSDK.prototype.get_by_path=TQSDK.prototype.getByPath,TQSDK.prototype.get_quotes_by_input=TQSDK.prototype.getQuotesByInput,TQSDK.prototype.get_quote=TQSDK.prototype.getQuote,TQSDK.prototype.set_chart=TQSDK.prototype.setChart,TQSDK.prototype.get_user=TQSDK.prototype.getUser,TQSDK.prototype.is_logined=TQSDK.prototype.isLogined,TQSDK.prototype.is_changed=TQSDK.prototype.isChanging,TQSDK.prototype.insert_order=TQSDK.prototype.insertOrder,TQSDK.prototype.auto_insert_order=TQSDK.prototype.autoInsertOrder,TQSDK.prototype.cancel_order=TQSDK.prototype.cancelOrder;var localforage=createCommonjsModule((function(e,t){
/*!
        localForage -- Offline Storage, Improved
        Version 1.7.3
        https://localforage.github.io/localForage
        (c) 2013-2017 Mozilla, Apache License 2.0
    */
e.exports=function e(t,n,r){function o(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof commonjsRequire&&commonjsRequire;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var f=n[a]={exports:{}};t[a][0].call(f.exports,(function(e){var n=t[a][1][e];return o(n||e)}),f,f.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof commonjsRequire&&commonjsRequire,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(e,t,n){(function(e){var n,r,o=e.MutationObserver||e.WebKitMutationObserver;if(o){var i=0,a=new o(f),s=e.document.createTextNode("");a.observe(s,{characterData:!0}),n=function(){s.data=i=++i%2}}else if(e.setImmediate||void 0===e.MessageChannel)n="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){f(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(f,0)};else{var c=new e.MessageChannel;c.port1.onmessage=f,n=function(){c.port2.postMessage(0)}}var u=[];function f(){var e,t;r=!0;for(var n=u.length;n;){for(t=u,u=[],e=-1;++e<n;)t[e]();n=u.length}r=!1}t.exports=function(e){1!==u.push(e)||r||n()}}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,n){var r=e(1);function o(){}var i={},a=["REJECTED"],s=["FULFILLED"],c=["PENDING"];function u(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,e!==o&&h(this,e)}function f(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function l(e,t,n){r((function(){var r;try{r=t(n)}catch(t){return i.reject(e,t)}r===e?i.reject(e,new TypeError("Cannot resolve promise with itself")):i.resolve(e,r)}))}function d(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function h(e,t){var n=!1;function r(t){n||(n=!0,i.reject(e,t))}function o(t){n||(n=!0,i.resolve(e,t))}var a=_((function(){t(o,r)}));"error"===a.status&&r(a.value)}function _(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}t.exports=u,u.prototype.catch=function(e){return this.then(null,e)},u.prototype.then=function(e,t){if("function"!=typeof e&&this.state===s||"function"!=typeof t&&this.state===a)return this;var n=new this.constructor(o);return this.state!==c?l(n,this.state===s?e:t,this.outcome):this.queue.push(new f(n,e,t)),n},f.prototype.callFulfilled=function(e){i.resolve(this.promise,e)},f.prototype.otherCallFulfilled=function(e){l(this.promise,this.onFulfilled,e)},f.prototype.callRejected=function(e){i.reject(this.promise,e)},f.prototype.otherCallRejected=function(e){l(this.promise,this.onRejected,e)},i.resolve=function(e,t){var n=_(d,t);if("error"===n.status)return i.reject(e,n.value);var r=n.value;if(r)h(e,r);else{e.state=s,e.outcome=t;for(var o=-1,a=e.queue.length;++o<a;)e.queue[o].callFulfilled(t)}return e},i.reject=function(e,t){e.state=a,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e},u.resolve=function(e){return e instanceof this?e:i.resolve(new this(o),e)},u.reject=function(e){var t=new this(o);return i.reject(t,e)},u.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,r=!1;if(!n)return this.resolve([]);for(var a=new Array(n),s=0,c=-1,u=new this(o);++c<n;)f(e[c],c);return u;function f(e,o){t.resolve(e).then((function(e){a[o]=e,++s!==n||r||(r=!0,i.resolve(u,a))}),(function(e){r||(r=!0,i.reject(u,e))}))}},u.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,r=!1;if(!n)return this.resolve([]);for(var a,s=-1,c=new this(o);++s<n;)a=e[s],t.resolve(a).then((function(e){r||(r=!0,i.resolve(c,e))}),(function(e){r||(r=!0,i.reject(c,e))}));return c}},{1:1}],3:[function(e,t,n){(function(t){"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,n){var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}();function i(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(o){if("TypeError"!==o.name)throw o;for(var n=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),r=0;r<e.length;r+=1)n.append(e[r]);return n.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var a=Promise;function s(e,t){t&&e.then((function(e){t(null,e)}),(function(e){t(e)}))}function c(e,t,n){"function"==typeof t&&e.then(t),"function"==typeof n&&e.catch(n)}function u(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function f(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var l="local-forage-detect-blob-support",d=void 0,h={},_=Object.prototype.toString,v="readonly",p="readwrite";function y(e){return"boolean"==typeof d?a.resolve(d):function(e){return new a((function(t){var n=e.transaction(l,p),r=i([""]);n.objectStore(l).put(r,"key"),n.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},n.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);t(n||!e||parseInt(e[1],10)>=43)}})).catch((function(){return!1}))}(e).then((function(e){return d=e}))}function m(e){var t=h[e.name],n={};n.promise=new a((function(e,t){n.resolve=e,n.reject=t})),t.deferredOperations.push(n),t.dbReady?t.dbReady=t.dbReady.then((function(){return n.promise})):t.dbReady=n.promise}function g(e){var t=h[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise}function b(e,t){var n=h[e.name].deferredOperations.pop();if(n)return n.reject(t),n.promise}function w(e,t){return new a((function(n,r){if(h[e.name]=h[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return n(e.db);m(e),e.db.close()}var i=[e.name];t&&i.push(e.version);var a=o.open.apply(o,i);t&&(a.onupgradeneeded=function(t){var n=a.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore(l)}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),a.onerror=function(e){e.preventDefault(),r(a.error)},a.onsuccess=function(){n(a.result),g(e)}}))}function S(e){return w(e,!1)}function I(e){return w(e,!0)}function k(e,t){if(!e.db)return!0;var n=!e.db.objectStoreNames.contains(e.storeName),r=e.version<e.db.version,o=e.version>e.db.version;if(r&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),o||n){if(n){var i=e.db.version+1;i>e.version&&(e.version=i)}return!0}return!1}function T(e){return i([function(e){for(var t=e.length,n=new ArrayBuffer(t),r=new Uint8Array(n),o=0;o<t;o++)r[o]=e.charCodeAt(o);return n}(atob(e.data))],{type:e.type})}function O(e){return e&&e.__local_forage_encoded_blob}function D(e){var t=this,n=t._initReady().then((function(){var e=h[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady}));return c(n,e,e),n}function E(e,t,n,r){void 0===r&&(r=1);try{var o=e.db.transaction(e.storeName,t);n(null,o)}catch(o){if(r>0&&(!e.db||"InvalidStateError"===o.name||"NotFoundError"===o.name))return a.resolve().then((function(){if(!e.db||"NotFoundError"===o.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),I(e)})).then((function(){return function(e){m(e);for(var t=h[e.name],n=t.forages,r=0;r<n.length;r++){var o=n[r];o._dbInfo.db&&(o._dbInfo.db.close(),o._dbInfo.db=null)}return e.db=null,S(e).then((function(t){return e.db=t,k(e)?I(e):t})).then((function(r){e.db=t.db=r;for(var o=0;o<n.length;o++)n[o]._dbInfo.db=r})).catch((function(t){throw b(e,t),t}))}(e).then((function(){E(e,t,n,r-1)}))})).catch(n);n(o)}}var j={_driver:"asyncStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var r in e)n[r]=e[r];var o=h[n.name];o||(o={forages:[],db:null,dbReady:null,deferredOperations:[]},h[n.name]=o),o.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=D);var i=[];function s(){return a.resolve()}for(var c=0;c<o.forages.length;c++){var u=o.forages[c];u!==t&&i.push(u._initReady().catch(s))}var f=o.forages.slice(0);return a.all(i).then((function(){return n.db=o.db,S(n)})).then((function(e){return n.db=e,k(n,t._defaultConfig.version)?I(n):e})).then((function(e){n.db=o.db=e,t._dbInfo=n;for(var r=0;r<f.length;r++){var i=f[r];i!==t&&(i._dbInfo.db=n.db,i._dbInfo.version=n.version)}}))},_support:function(){try{if(!o)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}(),iterate:function(e,t){var n=this,r=new a((function(t,r){n.ready().then((function(){E(n._dbInfo,v,(function(o,i){if(o)return r(o);try{var a=i.objectStore(n._dbInfo.storeName).openCursor(),s=1;a.onsuccess=function(){var n=a.result;if(n){var r=n.value;O(r)&&(r=T(r));var o=e(r,n.key,s++);void 0!==o?t(o):n.continue()}else t()},a.onerror=function(){r(a.error)}}catch(e){r(e)}}))})).catch(r)}));return s(r,t),r},getItem:function(e,t){var n=this;e=u(e);var r=new a((function(t,r){n.ready().then((function(){E(n._dbInfo,v,(function(o,i){if(o)return r(o);try{var a=i.objectStore(n._dbInfo.storeName).get(e);a.onsuccess=function(){var e=a.result;void 0===e&&(e=null),O(e)&&(e=T(e)),t(e)},a.onerror=function(){r(a.error)}}catch(e){r(e)}}))})).catch(r)}));return s(r,t),r},setItem:function(e,t,n){var r=this;e=u(e);var o=new a((function(n,o){var i;r.ready().then((function(){return i=r._dbInfo,"[object Blob]"===_.call(t)?y(i.db).then((function(e){return e?t:(n=t,new a((function(e,t){var r=new FileReader;r.onerror=t,r.onloadend=function(t){var r=btoa(t.target.result||"");e({__local_forage_encoded_blob:!0,data:r,type:n.type})},r.readAsBinaryString(n)})));var n})):t})).then((function(t){E(r._dbInfo,p,(function(i,a){if(i)return o(i);try{var s=a.objectStore(r._dbInfo.storeName);null===t&&(t=void 0);var c=s.put(t,e);a.oncomplete=function(){void 0===t&&(t=null),n(t)},a.onabort=a.onerror=function(){var e=c.error?c.error:c.transaction.error;o(e)}}catch(e){o(e)}}))})).catch(o)}));return s(o,n),o},removeItem:function(e,t){var n=this;e=u(e);var r=new a((function(t,r){n.ready().then((function(){E(n._dbInfo,p,(function(o,i){if(o)return r(o);try{var a=i.objectStore(n._dbInfo.storeName).delete(e);i.oncomplete=function(){t()},i.onerror=function(){r(a.error)},i.onabort=function(){var e=a.error?a.error:a.transaction.error;r(e)}}catch(e){r(e)}}))})).catch(r)}));return s(r,t),r},clear:function(e){var t=this,n=new a((function(e,n){t.ready().then((function(){E(t._dbInfo,p,(function(r,o){if(r)return n(r);try{var i=o.objectStore(t._dbInfo.storeName).clear();o.oncomplete=function(){e()},o.onabort=o.onerror=function(){var e=i.error?i.error:i.transaction.error;n(e)}}catch(e){n(e)}}))})).catch(n)}));return s(n,e),n},length:function(e){var t=this,n=new a((function(e,n){t.ready().then((function(){E(t._dbInfo,v,(function(r,o){if(r)return n(r);try{var i=o.objectStore(t._dbInfo.storeName).count();i.onsuccess=function(){e(i.result)},i.onerror=function(){n(i.error)}}catch(e){n(e)}}))})).catch(n)}));return s(n,e),n},key:function(e,t){var n=this,r=new a((function(t,r){e<0?t(null):n.ready().then((function(){E(n._dbInfo,v,(function(o,i){if(o)return r(o);try{var a=i.objectStore(n._dbInfo.storeName),s=!1,c=a.openCursor();c.onsuccess=function(){var n=c.result;n?0===e?t(n.key):s?t(n.key):(s=!0,n.advance(e)):t(null)},c.onerror=function(){r(c.error)}}catch(e){r(e)}}))})).catch(r)}));return s(r,t),r},keys:function(e){var t=this,n=new a((function(e,n){t.ready().then((function(){E(t._dbInfo,v,(function(r,o){if(r)return n(r);try{var i=o.objectStore(t._dbInfo.storeName).openCursor(),a=[];i.onsuccess=function(){var t=i.result;t?(a.push(t.key),t.continue()):e(a)},i.onerror=function(){n(i.error)}}catch(e){n(e)}}))})).catch(n)}));return s(n,e),n},dropInstance:function(e,t){t=f.apply(this,arguments);var n,r=this.config();if((e="function"!=typeof e&&e||{}).name||(e.name=e.name||r.name,e.storeName=e.storeName||r.storeName),e.name){var i=e.name===r.name&&this._dbInfo.db?a.resolve(this._dbInfo.db):S(e).then((function(t){var n=h[e.name],r=n.forages;n.db=t;for(var o=0;o<r.length;o++)r[o]._dbInfo.db=t;return t}));n=e.storeName?i.then((function(t){if(t.objectStoreNames.contains(e.storeName)){var n=t.version+1;m(e);var r=h[e.name],i=r.forages;t.close();for(var s=0;s<i.length;s++){var c=i[s];c._dbInfo.db=null,c._dbInfo.version=n}return new a((function(t,r){var i=o.open(e.name,n);i.onerror=function(e){i.result.close(),r(e)},i.onupgradeneeded=function(){i.result.deleteObjectStore(e.storeName)},i.onsuccess=function(){var e=i.result;e.close(),t(e)}})).then((function(e){r.db=e;for(var t=0;t<i.length;t++){var n=i[t];n._dbInfo.db=e,g(n._dbInfo)}})).catch((function(t){throw(b(e,t)||a.resolve()).catch((function(){})),t}))}})):i.then((function(t){m(e);var n=h[e.name],r=n.forages;t.close();for(var i=0;i<r.length;i++)r[i]._dbInfo.db=null;return new a((function(t,n){var r=o.deleteDatabase(e.name);r.onerror=r.onblocked=function(e){var t=r.result;t&&t.close(),n(e)},r.onsuccess=function(){var e=r.result;e&&e.close(),t(e)}})).then((function(e){n.db=e;for(var t=0;t<r.length;t++)g(r[t]._dbInfo)})).catch((function(t){throw(b(e,t)||a.resolve()).catch((function(){})),t}))}))}else n=a.reject("Invalid arguments");return s(n,t),n}},C="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",x="~~local_forage_type~",N=/^~~local_forage_type~([^~]+)~/,A="__lfsc__:",R=A.length,P="arbf",q="blob",B="si08",Q="ui08",L="uic8",M="si16",K="si32",U="ur16",W="ui32",F="fl32",z="fl64",G=R+P.length,Y=Object.prototype.toString;function J(e){var t,n,r,o,i,a=.75*e.length,s=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var u=new ArrayBuffer(a),f=new Uint8Array(u);for(t=0;t<s;t+=4)n=C.indexOf(e[t]),r=C.indexOf(e[t+1]),o=C.indexOf(e[t+2]),i=C.indexOf(e[t+3]),f[c++]=n<<2|r>>4,f[c++]=(15&r)<<4|o>>2,f[c++]=(3&o)<<6|63&i;return u}function H(e){var t,n=new Uint8Array(e),r="";for(t=0;t<n.length;t+=3)r+=C[n[t]>>2],r+=C[(3&n[t])<<4|n[t+1]>>4],r+=C[(15&n[t+1])<<2|n[t+2]>>6],r+=C[63&n[t+2]];return n.length%3==2?r=r.substring(0,r.length-1)+"=":n.length%3==1&&(r=r.substring(0,r.length-2)+"=="),r}var V={serialize:function(e,t){var n="";if(e&&(n=Y.call(e)),e&&("[object ArrayBuffer]"===n||e.buffer&&"[object ArrayBuffer]"===Y.call(e.buffer))){var r,o=A;e instanceof ArrayBuffer?(r=e,o+=P):(r=e.buffer,"[object Int8Array]"===n?o+=B:"[object Uint8Array]"===n?o+=Q:"[object Uint8ClampedArray]"===n?o+=L:"[object Int16Array]"===n?o+=M:"[object Uint16Array]"===n?o+=U:"[object Int32Array]"===n?o+=K:"[object Uint32Array]"===n?o+=W:"[object Float32Array]"===n?o+=F:"[object Float64Array]"===n?o+=z:t(new Error("Failed to get type for BinaryArray"))),t(o+H(r))}else if("[object Blob]"===n){var i=new FileReader;i.onload=function(){var n=x+e.type+"~"+H(this.result);t(A+q+n)},i.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(n){console.error("Couldn't convert value into a JSON string: ",e),t(null,n)}},deserialize:function(e){if(e.substring(0,R)!==A)return JSON.parse(e);var t,n=e.substring(G),r=e.substring(R,G);if(r===q&&N.test(n)){var o=n.match(N);t=o[1],n=n.substring(o[0].length)}var a=J(n);switch(r){case P:return a;case q:return i([a],{type:t});case B:return new Int8Array(a);case Q:return new Uint8Array(a);case L:return new Uint8ClampedArray(a);case M:return new Int16Array(a);case U:return new Uint16Array(a);case K:return new Int32Array(a);case W:return new Uint32Array(a);case F:return new Float32Array(a);case z:return new Float64Array(a);default:throw new Error("Unkown type: "+r)}},stringToBuffer:J,bufferToString:H};function X(e,t,n,r){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],n,r)}function Z(e,t,n,r,o,i){e.executeSql(n,r,o,(function(e,a){a.code===a.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],(function(e,s){s.rows.length?i(e,a):X(e,t,(function(){e.executeSql(n,r,o,i)}),i)}),i):i(e,a)}),i)}function $(e,t,n,r){var o=this;e=u(e);var i=new a((function(i,a){o.ready().then((function(){void 0===t&&(t=null);var s=t,c=o._dbInfo;c.serializer.serialize(t,(function(t,u){u?a(u):c.db.transaction((function(n){Z(n,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[e,t],(function(){i(s)}),(function(e,t){a(t)}))}),(function(t){if(t.code===t.QUOTA_ERR){if(r>0)return void i($.apply(o,[e,s,n,r-1]));a(t)}}))}))})).catch(a)}));return s(i,n),i}var ee={_driver:"webSQLStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var r in e)n[r]="string"!=typeof e[r]?e[r].toString():e[r];var o=new a((function(e,r){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(e){return r(e)}n.db.transaction((function(o){X(o,n,(function(){t._dbInfo=n,e()}),(function(e,t){r(t)}))}),r)}));return n.serializer=V,o},_support:"function"==typeof openDatabase,iterate:function(e,t){var n=this,r=new a((function(t,r){n.ready().then((function(){var o=n._dbInfo;o.db.transaction((function(n){Z(n,o,"SELECT * FROM "+o.storeName,[],(function(n,r){for(var i=r.rows,a=i.length,s=0;s<a;s++){var c=i.item(s),u=c.value;if(u&&(u=o.serializer.deserialize(u)),void 0!==(u=e(u,c.key,s+1)))return void t(u)}t()}),(function(e,t){r(t)}))}))})).catch(r)}));return s(r,t),r},getItem:function(e,t){var n=this;e=u(e);var r=new a((function(t,r){n.ready().then((function(){var o=n._dbInfo;o.db.transaction((function(n){Z(n,o,"SELECT * FROM "+o.storeName+" WHERE key = ? LIMIT 1",[e],(function(e,n){var r=n.rows.length?n.rows.item(0).value:null;r&&(r=o.serializer.deserialize(r)),t(r)}),(function(e,t){r(t)}))}))})).catch(r)}));return s(r,t),r},setItem:function(e,t,n){return $.apply(this,[e,t,n,1])},removeItem:function(e,t){var n=this;e=u(e);var r=new a((function(t,r){n.ready().then((function(){var o=n._dbInfo;o.db.transaction((function(n){Z(n,o,"DELETE FROM "+o.storeName+" WHERE key = ?",[e],(function(){t()}),(function(e,t){r(t)}))}))})).catch(r)}));return s(r,t),r},clear:function(e){var t=this,n=new a((function(e,n){t.ready().then((function(){var r=t._dbInfo;r.db.transaction((function(t){Z(t,r,"DELETE FROM "+r.storeName,[],(function(){e()}),(function(e,t){n(t)}))}))})).catch(n)}));return s(n,e),n},length:function(e){var t=this,n=new a((function(e,n){t.ready().then((function(){var r=t._dbInfo;r.db.transaction((function(t){Z(t,r,"SELECT COUNT(key) as c FROM "+r.storeName,[],(function(t,n){var r=n.rows.item(0).c;e(r)}),(function(e,t){n(t)}))}))})).catch(n)}));return s(n,e),n},key:function(e,t){var n=this,r=new a((function(t,r){n.ready().then((function(){var o=n._dbInfo;o.db.transaction((function(n){Z(n,o,"SELECT key FROM "+o.storeName+" WHERE id = ? LIMIT 1",[e+1],(function(e,n){var r=n.rows.length?n.rows.item(0).key:null;t(r)}),(function(e,t){r(t)}))}))})).catch(r)}));return s(r,t),r},keys:function(e){var t=this,n=new a((function(e,n){t.ready().then((function(){var r=t._dbInfo;r.db.transaction((function(t){Z(t,r,"SELECT key FROM "+r.storeName,[],(function(t,n){for(var r=[],o=0;o<n.rows.length;o++)r.push(n.rows.item(o).key);e(r)}),(function(e,t){n(t)}))}))})).catch(n)}));return s(n,e),n},dropInstance:function(e,t){t=f.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var r,o=this;return s(r=e.name?new a((function(t){var r;r=e.name===n.name?o._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:r,storeNames:[e.storeName]}):t(function(e){return new a((function(t,n){e.transaction((function(r){r.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(n,r){for(var o=[],i=0;i<r.rows.length;i++)o.push(r.rows.item(i).name);t({db:e,storeNames:o})}),(function(e,t){n(t)}))}),(function(e){n(e)}))}))}(r))})).then((function(e){return new a((function(t,n){e.db.transaction((function(r){function o(e){return new a((function(t,n){r.executeSql("DROP TABLE IF EXISTS "+e,[],(function(){t()}),(function(e,t){n(t)}))}))}for(var i=[],s=0,c=e.storeNames.length;s<c;s++)i.push(o(e.storeNames[s]));a.all(i).then((function(){t()})).catch((function(e){n(e)}))}),(function(e){n(e)}))}))})):a.reject("Invalid arguments"),t),r}};function te(e,t){var n=e.name+"/";return e.storeName!==t.storeName&&(n+=e.storeName+"/"),n}function ne(){return!function(){try{return localStorage.setItem("_localforage_support_test",!0),localStorage.removeItem("_localforage_support_test"),!1}catch(e){return!0}}()||localStorage.length>0}var re={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var n in e)t[n]=e[n];return t.keyPrefix=te(e,this._defaultConfig),ne()?(this._dbInfo=t,t.serializer=V,a.resolve()):a.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}(),iterate:function(e,t){var n=this,r=n.ready().then((function(){for(var t=n._dbInfo,r=t.keyPrefix,o=r.length,i=localStorage.length,a=1,s=0;s<i;s++){var c=localStorage.key(s);if(0===c.indexOf(r)){var u=localStorage.getItem(c);if(u&&(u=t.serializer.deserialize(u)),void 0!==(u=e(u,c.substring(o),a++)))return u}}}));return s(r,t),r},getItem:function(e,t){var n=this;e=u(e);var r=n.ready().then((function(){var t=n._dbInfo,r=localStorage.getItem(t.keyPrefix+e);return r&&(r=t.serializer.deserialize(r)),r}));return s(r,t),r},setItem:function(e,t,n){var r=this;e=u(e);var o=r.ready().then((function(){void 0===t&&(t=null);var n=t;return new a((function(o,i){var a=r._dbInfo;a.serializer.serialize(t,(function(t,r){if(r)i(r);else try{localStorage.setItem(a.keyPrefix+e,t),o(n)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||i(e),i(e)}}))}))}));return s(o,n),o},removeItem:function(e,t){var n=this;e=u(e);var r=n.ready().then((function(){var t=n._dbInfo;localStorage.removeItem(t.keyPrefix+e)}));return s(r,t),r},clear:function(e){var t=this,n=t.ready().then((function(){for(var e=t._dbInfo.keyPrefix,n=localStorage.length-1;n>=0;n--){var r=localStorage.key(n);0===r.indexOf(e)&&localStorage.removeItem(r)}}));return s(n,e),n},length:function(e){var t=this.keys().then((function(e){return e.length}));return s(t,e),t},key:function(e,t){var n=this,r=n.ready().then((function(){var t,r=n._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(r.keyPrefix.length)),t}));return s(r,t),r},keys:function(e){var t=this,n=t.ready().then((function(){for(var e=t._dbInfo,n=localStorage.length,r=[],o=0;o<n;o++){var i=localStorage.key(o);0===i.indexOf(e.keyPrefix)&&r.push(i.substring(e.keyPrefix.length))}return r}));return s(n,e),n},dropInstance:function(e,t){if(t=f.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var n=this.config();e.name=e.name||n.name,e.storeName=e.storeName||n.storeName}var r,o=this;return s(r=e.name?new a((function(t){e.storeName?t(te(e,o._defaultConfig)):t(e.name+"/")})).then((function(e){for(var t=localStorage.length-1;t>=0;t--){var n=localStorage.key(t);0===n.indexOf(e)&&localStorage.removeItem(n)}})):a.reject("Invalid arguments"),t),r}},oe=function(e,t){for(var n,r,o=e.length,i=0;i<o;){if((n=e[i])===(r=t)||"number"==typeof n&&"number"==typeof r&&isNaN(n)&&isNaN(r))return!0;i++}return!1},ie=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},ae={},se={},ce={INDEXEDDB:j,WEBSQL:ee,LOCALSTORAGE:re},ue=[ce.INDEXEDDB._driver,ce.WEBSQL._driver,ce.LOCALSTORAGE._driver],fe=["dropInstance"],le=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(fe),de={description:"",driver:ue.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function he(e,t){e[t]=function(){var n=arguments;return e.ready().then((function(){return e[t].apply(e,n)}))}}function _e(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var n in t)t.hasOwnProperty(n)&&(ie(t[n])?arguments[0][n]=t[n].slice():arguments[0][n]=t[n])}return arguments[0]}var ve=new(function(){function e(t){for(var n in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ce)if(ce.hasOwnProperty(n)){var r=ce[n],o=r._driver;this[n]=o,ae[o]||this.defineDriver(r)}this._defaultConfig=_e({},de),this._config=_e({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":r(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e&&e.driver)||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,n){var r=new a((function(t,n){try{var r=e._driver,o=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void n(o);for(var i=le.concat("_initStorage"),c=0,u=i.length;c<u;c++){var f=i[c];if((!oe(fe,f)||e[f])&&"function"!=typeof e[f])return void n(o)}!function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),n=a.reject(t);return s(n,arguments[arguments.length-1]),n}},n=0,r=fe.length;n<r;n++){var o=fe[n];e[o]||(e[o]=t(o))}}();var l=function(n){ae[r]&&console.info("Redefining LocalForage driver: "+r),ae[r]=e,se[r]=n,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(l,n):l(!!e._support):l(!0)}catch(e){n(e)}}));return c(r,t,n),r},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,n){var r=ae[e]?a.resolve(ae[e]):a.reject(new Error("Driver not found."));return c(r,t,n),r},e.prototype.getSerializer=function(e){var t=a.resolve(V);return c(t,e),t},e.prototype.ready=function(e){var t=this,n=t._driverSet.then((function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready}));return c(n,e,e),n},e.prototype.setDriver=function(e,t,n){var r=this;ie(e)||(e=[e]);var o=this._getSupportedDrivers(e);function i(){r._config.driver=r.driver()}function s(e){return r._extend(e),i(),r._ready=r._initStorage(r._config),r._ready}var u=null!==this._driverSet?this._driverSet.catch((function(){return a.resolve()})):a.resolve();return this._driverSet=u.then((function(){var e=o[0];return r._dbInfo=null,r._ready=null,r.getDriver(e).then((function(e){r._driver=e._driver,i(),r._wrapLibraryMethodsWithReady(),r._initDriver=function(e){return function(){var t=0;return function n(){for(;t<e.length;){var o=e[t];return t++,r._dbInfo=null,r._ready=null,r.getDriver(o).then(s).catch(n)}i();var c=new Error("No available storage method found.");return r._driverSet=a.reject(c),r._driverSet}()}}(o)}))})).catch((function(){i();var e=new Error("No available storage method found.");return r._driverSet=a.reject(e),r._driverSet})),c(this._driverSet,t,n),this._driverSet},e.prototype.supports=function(e){return!!se[e]},e.prototype._extend=function(e){_e(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,r=e.length;n<r;n++){var o=e[n];this.supports(o)&&t.push(o)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=le.length;e<t;e++)he(this,le[e])},e.prototype.createInstance=function(t){return new e(t)},e}());t.exports=ve},{3:3}]},{},[4])(4)}));TQSDK.axios=axios,TQSDK.TqWebsocket=TqWebsocket,TQSDK.TQData=DataManager,TQSDK.version=version;var DB_NAME="his_settlements",stores={},oldVersion=localStorage.getItem("cc_db_ver");if(oldVersion!==db_version){var DBDeleteRequest=indexedDB.deleteDatabase(DB_NAME);DBDeleteRequest.onerror=function(e){console.log("Error deleting database.")},DBDeleteRequest.onsuccess=function(e){localStorage.setItem("cc_db_ver",db_version)}}return TQSDK.store={getContent:function(e,t){return void 0===stores[e]&&(stores[e]=localforage.createInstance({name:DB_NAME,storeName:e})),stores[e].getItem(String(t))},setContent:function(e,t,n){return void 0===stores[e]&&(stores[e]=localforage.createInstance({name:DB_NAME,storeName:e})),stores[e].setItem(String(t),n)}},TQSDK}));
